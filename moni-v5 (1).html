<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Moni - Financial Confidence</title>
  <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --bg: #faf9f7;
      --card: #ffffff;
      --text: #1a1a1a;
      --text-soft: #6b6b6b;
      --text-muted: #9a9a9a;
      --accent: #1a1a1a;
      --green: #22c55e;
      --green-light: #f0fdf4;
      --orange: #f59e0b;
      --orange-light: #fffbeb;
      --border: #e8e6e3;
      --purple: #8b5cf6;
      --purple-light: #f5f3ff;
    }

    body {
      min-height: 100vh;
      background: #1a1a1a;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Be Vietnam Pro', sans-serif;
      padding: 20px;
    }

    .phone {
      width: 100%;
      max-width: 390px;
      height: 844px;
      background: var(--bg);
      border-radius: 44px;
      box-shadow: 0 25px 80px rgba(0,0,0,0.5);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .phone.splash-bg {
      background: linear-gradient(160deg, #1a1a1a 0%, #2d2d2d 100%);
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
    }

    .btn-back {
      width: 44px;
      height: 44px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .progress-dots {
      display: flex;
      gap: 6px;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 4px;
      background: var(--border);
      transition: all 0.3s;
    }

    .dot.active {
      width: 24px;
      background: var(--text);
    }

    .content {
      flex: 1;
      overflow-y: auto;
      padding: 0 24px;
    }

    .footer {
      padding: 16px 24px 40px;
    }

    .btn {
      width: 100%;
      padding: 18px 24px;
      background: var(--text);
      border: none;
      border-radius: 16px;
      color: white;
      font-size: 17px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      transition: transform 0.2s, opacity 0.2s;
    }

    .btn:hover { transform: scale(1.02); }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

    .btn.secondary {
      background: transparent;
      color: var(--text-muted);
      padding: 14px 24px;
    }

    .btn.white {
      background: white;
      color: var(--text);
    }

    .input {
      width: 100%;
      padding: 18px 20px;
      border: 2px solid var(--border);
      border-radius: 16px;
      font-size: 17px;
      font-family: inherit;
      outline: none;
      transition: border-color 0.2s;
      background: var(--card);
    }

    .input:focus { border-color: var(--text); }

    .hidden { display: none !important; }

    /* Splash */
    .splash {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 60px 32px 48px;
      text-align: center;
    }

    .splash-logo { font-size: 80px; margin-bottom: 16px; }
    .splash-title { font-size: 48px; font-weight: 800; color: white; letter-spacing: -1px; }
    .splash-tagline { font-size: 17px; color: rgba(255,255,255,0.7); margin-top: 12px; line-height: 1.5; }

    /* Onboarding */
    .ob-icon { font-size: 64px; margin-bottom: 20px; }
    .ob-title { font-size: 26px; font-weight: 700; color: var(--text); margin-bottom: 12px; line-height: 1.3; }
    .ob-desc { font-size: 16px; color: var(--text-soft); line-height: 1.6; }
    .ob-center { text-align: center; padding-top: 20px; }

    .benefits { display: flex; flex-direction: column; gap: 14px; margin: 28px 0; }
    .benefit { display: flex; align-items: center; gap: 14px; padding: 16px 18px; background: var(--card); border: 1px solid var(--border); border-radius: 16px; }
    .benefit-icon { font-size: 24px; }
    .benefit-text { font-size: 15px; color: var(--text); }

    .quote-box { padding: 20px 24px; background: var(--green-light); border-radius: 20px; text-align: center; }
    .quote-text { font-size: 15px; color: #166534; font-style: italic; line-height: 1.6; }

    /* Quiz */
    .quiz-progress { display: flex; align-items: center; gap: 12px; }
    .quiz-bar { width: 100px; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }
    .quiz-bar-fill { height: 100%; background: var(--text); transition: width 0.3s; }
    .quiz-count { font-size: 14px; font-weight: 600; color: var(--text-muted); }
    .quiz-badge { display: inline-block; padding: 8px 16px; background: var(--purple-light); border-radius: 20px; font-size: 13px; font-weight: 600; color: var(--purple); margin-bottom: 20px; }
    .quiz-question { font-size: 20px; font-weight: 700; color: var(--text); line-height: 1.5; margin-bottom: 28px; }
    .quiz-option { display: flex; align-items: center; gap: 14px; width: 100%; padding: 18px 20px; background: var(--card); border: 2px solid var(--border); border-radius: 16px; cursor: pointer; text-align: left; margin-bottom: 12px; transition: all 0.2s; font-family: inherit; }
    .quiz-option:hover { border-color: var(--text); background: var(--bg); }
    .quiz-option-icon { font-size: 24px; }
    .quiz-option-text { font-size: 15px; color: var(--text); }

    /* Result */
    .result-card { background: linear-gradient(135deg, var(--purple), #a855f7); border-radius: 28px; padding: 36px 28px; text-align: center; color: white; margin: 20px 0; }
    .result-emoji { font-size: 72px; margin-bottom: 16px; }
    .result-type { font-size: 28px; font-weight: 800; }
    .result-tag { font-size: 16px; opacity: 0.9; margin-top: 8px; }
    .result-desc { font-size: 16px; color: var(--text-soft); line-height: 1.7; text-align: center; margin-top: 20px; }

    /* Income */
    .income-input-wrap { display: flex; background: var(--card); border-radius: 16px; border: 2px solid var(--border); overflow: hidden; margin: 24px 0; }
    .income-input-wrap:focus-within { border-color: var(--text); }
    .income-input { flex: 1; border: none; padding: 20px; font-size: 28px; font-weight: 700; text-align: center; outline: none; font-family: inherit; background: transparent; }
    .income-unit { display: flex; align-items: center; padding: 0 20px; font-size: 16px; color: var(--text-muted); background: var(--bg); }

    .presets { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 24px; }
    .preset { padding: 12px 20px; border-radius: 12px; border: 1px solid var(--border); background: var(--card); font-size: 15px; font-weight: 600; color: var(--text-soft); cursor: pointer; transition: all 0.2s; font-family: inherit; }
    .preset:hover, .preset.active { background: var(--text); color: white; border-color: var(--text); }

    .privacy-note { display: flex; align-items: center; gap: 10px; padding: 14px 16px; background: var(--bg); border-radius: 14px; }
    .privacy-note span:first-child { font-size: 18px; }
    .privacy-note span:last-child { font-size: 13px; color: var(--text-muted); }

    /* Goals */
    .goal-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin: 24px 0; }
    .goal-item { display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 18px 12px; background: var(--card); border: 2px solid var(--border); border-radius: 18px; cursor: pointer; transition: all 0.2s; }
    .goal-item:hover { border-color: var(--text-soft); }
    .goal-item.selected { border-color: var(--green); background: var(--green-light); }
    .goal-item-icon { font-size: 32px; }
    .goal-item-name { font-size: 13px; font-weight: 600; color: var(--text); }

    .selected-goals { display: flex; flex-direction: column; gap: 12px; margin-top: 20px; }
    .selected-goal { display: flex; align-items: center; gap: 14px; padding: 16px 18px; background: var(--green-light); border: 2px solid #86efac; border-radius: 16px; }
    .selected-goal-icon { font-size: 28px; }
    .selected-goal-info { flex: 1; }
    .selected-goal-name { font-size: 15px; font-weight: 600; color: var(--text); }
    .selected-goal-amount { font-size: 13px; color: var(--text-soft); }
    .selected-goal-remove { width: 32px; height: 32px; background: #fee2e2; border: none; border-radius: 10px; color: #ef4444; font-size: 18px; cursor: pointer; }

    /* Allocation */
    .allocation-card { background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 20px; margin-bottom: 16px; }
    .allocation-header { display: flex; align-items: center; gap: 14px; margin-bottom: 16px; }
    .allocation-icon { font-size: 32px; }
    .allocation-name { font-size: 16px; font-weight: 600; color: var(--text); }
    .allocation-target { font-size: 13px; color: var(--text-muted); }
    .allocation-input-row { display: flex; align-items: center; gap: 12px; }
    .allocation-input { flex: 1; padding: 14px 16px; border: 2px solid var(--border); border-radius: 12px; font-size: 18px; font-weight: 600; font-family: inherit; outline: none; text-align: center; }
    .allocation-input:focus { border-color: var(--text); }
    .allocation-per { font-size: 14px; color: var(--text-muted); }
    .allocation-time { margin-top: 12px; padding: 12px; background: var(--bg); border-radius: 10px; text-align: center; font-size: 13px; color: var(--text-soft); }
    .allocation-time strong { color: var(--green); }

    /* Main App */
    .status-bar { display: flex; justify-content: space-between; padding: 14px 28px 10px; font-size: 14px; font-weight: 600; }
    .main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; }
    .greeting { font-size: 18px; font-weight: 600; color: var(--text); }
    .avatar { width: 40px; height: 40px; background: linear-gradient(135deg, #e0e0e0, #f5f5f5); border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 18px; }

    .spendable { text-align: center; margin-bottom: 40px; }
    .spendable-label { font-size: 14px; color: var(--text-muted); margin-bottom: 8px; }
    .spendable-amount { font-size: 56px; font-weight: 800; color: var(--text); letter-spacing: -3px; line-height: 1; margin-bottom: 8px; }
    .spendable-amount .unit { font-size: 32px; font-weight: 600; color: var(--text-soft); }
    .spendable-sub { font-size: 14px; color: var(--text-muted); }
    .spendable-sub span { color: var(--text-soft); font-weight: 600; }

    .goals-status { display: flex; gap: 12px; margin-bottom: 24px; }
    .goal-pill { flex: 1; background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 14px 16px; display: flex; align-items: center; gap: 12px; }
    .goal-pill.on-track { background: var(--green-light); border-color: #bbf7d0; }
    .goal-pill.behind { background: var(--orange-light); border-color: #fde68a; }
    .goal-emoji { font-size: 24px; }
    .goal-info { flex: 1; min-width: 0; }
    .goal-name { font-size: 13px; font-weight: 600; color: var(--text); }
    .goal-time { display: flex; flex-direction: column; gap: 2px; margin-top: 2px; }
    .time-expect { font-size: 11px; color: var(--text-muted); }
    .time-reality { font-size: 11px; font-weight: 600; }
    .time-reality.on-track { color: var(--green); }
    .time-reality.behind { color: var(--orange); }
    .goal-progress { width: 100%; height: 4px; background: rgba(0,0,0,0.08); border-radius: 2px; margin-top: 8px; overflow: hidden; }
    .goal-progress-fill { height: 100%; background: var(--green); border-radius: 2px; }
    .goal-pill.behind .goal-progress-fill { background: var(--orange); }

    .recent-section { margin-bottom: 24px; }
    .recent-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .recent-title { font-size: 13px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .recent-total { font-size: 14px; font-weight: 600; color: var(--text-soft); }
    .recent-list { background: var(--card); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; }
    .recent-item { display: flex; align-items: center; gap: 12px; padding: 14px 16px; border-bottom: 1px solid var(--border); }
    .recent-item:last-child { border-bottom: none; }
    .recent-emoji { font-size: 18px; }
    .recent-name { flex: 1; font-size: 14px; color: var(--text); }
    .recent-amount { font-size: 14px; font-weight: 600; color: var(--text-soft); }

    .spacer { flex: 1; }

    .ask-section { padding-bottom: 24px; }
    .ask-container { background: var(--card); border: 2px solid var(--border); border-radius: 20px; padding: 6px; transition: all 0.2s ease; }
    .ask-container:focus-within { border-color: var(--text); }
    .ask-row { display: flex; align-items: center; gap: 12px; }
    .ask-icon { width: 42px; height: 42px; background: var(--bg); border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
    .ask-input { flex: 1; border: none; background: transparent; font-size: 16px; font-family: inherit; color: var(--text); outline: none; padding: 12px 0; }
    .ask-input::placeholder { color: var(--text-muted); }
    .ask-btn { width: 42px; height: 42px; background: var(--text); border: none; border-radius: 14px; color: white; font-size: 18px; cursor: pointer; transition: transform 0.2s; }
    .ask-btn:hover { transform: scale(1.05); }
    .ask-hint { text-align: center; font-size: 13px; color: var(--text-muted); margin-top: 16px; }

    .chips { display: flex; gap: 8px; margin-top: 14px; overflow-x: auto; padding-bottom: 4px; }
    .chips::-webkit-scrollbar { display: none; }
    .chip { flex-shrink: 0; padding: 10px 16px; background: var(--bg); border: 1px solid var(--border); border-radius: 12px; font-size: 14px; color: var(--text-soft); cursor: pointer; transition: all 0.2s; font-family: inherit; }
    .chip:hover { background: var(--card); border-color: var(--text-soft); }

    .response { margin-top: 20px; }
    .response.show { display: block; animation: slideUp 0.3s ease; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .response-bubble { background: var(--bg); border-radius: 18px; padding: 18px 20px; }
    .response-text { font-size: 15px; color: var(--text); line-height: 1.6; margin-bottom: 16px; }
    .response-meta { font-size: 13px; color: var(--text-muted); padding: 12px 0; border-top: 1px solid var(--border); margin-bottom: 16px; }
    .response-actions { display: flex; gap: 10px; }
    .res-btn { flex: 1; padding: 14px; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.2s; }
    .res-btn.primary { background: var(--text); border: none; color: white; }
    .res-btn.secondary { background: transparent; border: 1px solid var(--border); color: var(--text-soft); }

    .tab-bar { display: flex; justify-content: space-around; padding: 12px 0 32px; background: var(--bg); border-top: 1px solid var(--border); }
    .tab { display: flex; flex-direction: column; align-items: center; gap: 4px; background: none; border: none; cursor: pointer; padding: 8px 20px; }
    .tab-icon { font-size: 22px; opacity: 0.4; }
    .tab.active .tab-icon { opacity: 1; }
    .tab-label { font-size: 11px; font-weight: 600; color: var(--text-muted); }
    .tab.active .tab-label { color: var(--text); }

    /* FAB */
    .fab {
      position: absolute;
      bottom: 100px;
      right: 24px;
      width: 56px;
      height: 56px;
      background: var(--text);
      border: none;
      border-radius: 16px;
      color: white;
      font-size: 28px;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(0,0,0,0.25);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s, box-shadow 0.2s;
      z-index: 50;
    }
    .fab:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 25px rgba(0,0,0,0.3);
    }

    /* Chat loading */
    .typing {
      display: flex;
      gap: 4px;
      padding: 8px 0;
    }
    .typing span {
      width: 8px;
      height: 8px;
      background: var(--text-muted);
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out;
    }
    .typing span:nth-child(1) { animation-delay: 0s; }
    .typing span:nth-child(2) { animation-delay: 0.2s; }
    .typing span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
      40% { transform: scale(1); opacity: 1; }
    }
  </style>
</head>
<body>
  <div id="app" class="phone"></div>

  <script>
    let state = {
      screen: 'splash',
      step: 0,
      quizStep: -1,
      quizAnswers: [],
      userName: '',
      archetype: null,
      income: '',
      fixedExpenses: [],  // [{ id, e, name, amount }]
      goals: [],
      allocations: {},
      transactions: [
        { emoji: '‚òï', name: 'Cafe', amount: 50000 },
        { emoji: 'üçú', name: 'C∆°m tr∆∞a', amount: 45000 },
        { emoji: 'üöó', name: 'Grab v·ªÅ nh√†', amount: 85000 },
        { emoji: 'üõí', name: 'Si√™u th·ªã', amount: 140000 },
      ],
      showAddExpense: false,
      showAddFixed: false,
      showAddGoal: false,
      newExpense: { name: '', amount: '' },
      newFixed: { name: '', amount: '' },
      newGoal: { name: '', amount: '' },
      chatLoading: false,
      chatResponse: null,
      chatParsed: null, // { item, amount }
    };

    const DEFAULT_FIXED = [
      { id: 'rent', e: 'üè†', name: 'Ti·ªÅn nh√†', amount: '' },
      { id: 'electric', e: 'üí°', name: 'ƒêi·ªán', amount: '' },
      { id: 'water', e: 'üíß', name: 'N∆∞·ªõc', amount: '' },
      { id: 'internet', e: 'üì∂', name: 'Internet', amount: '' },
      { id: 'phone', e: 'üì±', name: 'ƒêi·ªán tho·∫°i', amount: '' },
      { id: 'insurance', e: 'üõ°Ô∏è', name: 'B·∫£o hi·ªÉm', amount: '' },
    ];

    // Initialize fixed expenses from defaults
    state.fixedExpenses = DEFAULT_FIXED.map(f => ({...f}));

    const ARCHETYPES = {
      dreamer: { emoji: '‚ú®', name: 'The Dreamer', tag: 'Ng∆∞·ªùi m∆° m·ªông', color: '#8b5cf6' },
      experiencer: { emoji: 'üé¢', name: 'The Experiencer', tag: 'Ng∆∞·ªùi tr·∫£i nghi·ªám', color: '#f97316' },
      giver: { emoji: 'üíù', name: 'The Giver', tag: 'Ng∆∞·ªùi cho ƒëi', color: '#ec4899' },
      planner: { emoji: 'üéØ', name: 'The Planner', tag: 'Ng∆∞·ªùi k·∫ø ho·∫°ch', color: '#10b981' },
    };

    const QUIZ = [
      { q: 'Khi nh·∫≠n ƒë∆∞·ª£c ti·ªÅn th∆∞·ªüng b·∫•t ng·ªù, b·∫°n th∆∞·ªùng...', opts: [
        { e: 'üìã', text: 'L√™n k·∫ø ho·∫°ch c·ª• th·ªÉ cho n√≥', type: 'planner' },
        { e: 'üéÅ', text: 'T·ª± th∆∞·ªüng cho m√¨nh ngay', type: 'experiencer' },
        { e: 'üíù', text: 'Nghƒ© ƒë·∫øn qu√† cho ng∆∞·ªùi th√¢n', type: 'giver' },
        { e: '‚ú®', text: 'M∆° v·ªÅ nh·ªØng possibilities', type: 'dreamer' },
      ]},
      { q: 'B·∫°n hay v∆∞·ª£t chi ti√™u nh·∫•t khi n√†o?', opts: [
        { e: 'üéâ', text: 'ƒêi ch∆°i v·ªõi b·∫°n b√®', type: 'experiencer' },
        { e: 'ü§ù', text: 'C√≥ ai ƒë√≥ c·∫ßn gi√∫p ƒë·ª°', type: 'giver' },
        { e: 'üÜï', text: 'B·ªã thu h√∫t b·ªüi c√°i m·ªõi', type: 'dreamer' },
        { e: '‚úÖ', text: 'Hi·∫øm khi v∆∞·ª£t chi', type: 'planner' },
      ]},
      { q: 'C·∫£m x√∫c c·ªßa b·∫°n khi nghƒ© v·ªÅ ti·ªÅn...', opts: [
        { e: 'üöÄ', text: 'Excited v·ªÅ t∆∞∆°ng lai', type: 'dreamer' },
        { e: 'üòå', text: 'Tho·∫£i m√°i, s·ªëng hi·ªán t·∫°i', type: 'experiencer' },
        { e: 'ü´Ç', text: 'Lo l·∫Øng cho ng∆∞·ªùi th√¢n', type: 'giver' },
        { e: 'üí™', text: 'C·∫£m gi√°c ki·ªÉm so√°t', type: 'planner' },
      ]},
      { q: 'ƒêi·ªÅu n√†o m√¥ t·∫£ b·∫°n nh·∫•t?', opts: [
        { e: 'üåà', text: 'Nhi·ªÅu ∆∞·ªõc m∆°, kh√≥ focus', type: 'dreamer' },
        { e: 'üì∏', text: 'K·ª∑ ni·ªám quan tr·ªçng h∆°n ti·∫øt ki·ªám', type: 'experiencer' },
        { e: 'üòä', text: 'Vui khi ƒë∆∞·ª£c gi√∫p ng∆∞·ªùi kh√°c', type: 'giver' },
        { e: 'üìä', text: 'Th√≠ch k·∫ø ho·∫°ch r√µ r√†ng', type: 'planner' },
      ]},
    ];

    const GOALS = [
      { id: 'laptop', e: 'üíª', name: 'Laptop', amount: 25000000 },
      { id: 'phone', e: 'üì±', name: 'ƒêi·ªán tho·∫°i', amount: 15000000 },
      { id: 'trip', e: '‚úàÔ∏è', name: 'Du l·ªãch', amount: 10000000 },
      { id: 'bike', e: 'üèçÔ∏è', name: 'Xe m√°y', amount: 50000000 },
      { id: 'emergency', e: 'üõ°Ô∏è', name: 'Qu·ªπ kh·∫©n c·∫•p', amount: 20000000 },
      { id: 'wedding', e: 'üíí', name: 'ƒê√°m c∆∞·ªõi', amount: 100000000 },
    ];

    const $ = id => document.getElementById(id);
    const fmt = n => {
      if (n >= 1000000) return (n / 1000000).toFixed(1).replace('.0', '') + 'tr';
      if (n >= 1000) return (n / 1000).toFixed(0) + 'k';
      return n.toString();
    };

    const totalFixed = () => state.fixedExpenses.reduce((a, b) => a + (parseInt(b.amount) || 0), 0);
    const totalAllocation = () => Object.values(state.allocations).reduce((a, b) => a + (parseInt(b) || 0), 0);
    const spendable = () => (parseInt(state.income) || 0) - totalFixed() - totalAllocation();
    const todaySpent = () => state.transactions.reduce((a, b) => a + b.amount, 0);

    const render = () => {
      const app = $('app');
      if (state.screen === 'splash') renderSplash(app);
      else if (state.screen === 'onboarding') renderOnboarding(app);
      else if (state.screen === 'main') renderMain(app);
    };

    const renderSplash = (app) => {
      app.className = 'phone splash-bg';
      app.innerHTML = `
        <div class="splash">
          <div></div>
          <div>
            <div class="splash-logo">üåø</div>
            <div class="splash-title">Moni</div>
            <div class="splash-tagline">Qu·∫£n l√Ω ti·ªÅn theo c√°ch c·ªßa b·∫°n.<br>Kh√¥ng ph√°n x√©t. Ch·ªâ ƒë·ªìng h√†nh.</div>
          </div>
          <button class="btn white" onclick="startOnboarding()">B·∫Øt ƒë·∫ßu ‚Üí</button>
        </div>
      `;
    };

    const renderOnboarding = (app) => {
      app.className = 'phone';
      const dots = [0,1,2,3,4,5,6].map(i => `<div class="dot ${i <= state.step ? 'active' : ''}"></div>`).join('');
      
      if (state.step === 0) {
        app.innerHTML = `
          <div class="header">
            <button class="btn-back" onclick="goSplash()">‚Üê</button>
            <div class="progress-dots">${dots}</div>
            <div style="width:44px"></div>
          </div>
          <div class="content">
            <div class="ob-center">
              <div class="ob-icon">üëã</div>
              <div class="ob-title">Ch√†o m·ª´ng ƒë·∫øn Moni!</div>
              <div class="ob-desc">Moni s·∫Ω gi√∫p b·∫°n ti√™u ti·ªÅn c√≥ ch·ªß ƒë√≠ch ‚Äî kh√¥ng ph·∫£i theo d√µi t·ª´ng ƒë·ªìng, m√† l√† bi·∫øt m√¨nh ƒëang ·ªü ƒë√¢u tr√™n ƒë∆∞·ªùng ƒë·∫øn m·ª•c ti√™u.</div>
            </div>
            <div style="margin-top:40px">
              <label style="font-size:14px;font-weight:600;color:var(--text-soft);display:block;margin-bottom:12px">M√¨nh g·ªçi b·∫°n l√† g√¨ nh·ªâ?</label>
              <input id="nameInput" class="input" style="text-align:center;font-weight:600" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n..." value="${state.userName}" onkeyup="state.userName=this.value;updateBtn()">
            </div>
          </div>
          <div class="footer">
            <button class="btn" id="nextBtn" ${state.userName.trim() ? '' : 'disabled'} onclick="nextStep()">Ti·∫øp t·ª•c ‚Üí</button>
          </div>
        `;
        return;
      }

      if (state.step === 1) {
        if (state.quizStep === -1) {
          app.innerHTML = `
            <div class="header">
              <button class="btn-back" onclick="prevStep()">‚Üê</button>
              <div class="progress-dots">${dots}</div>
              <div style="width:44px"></div>
            </div>
            <div class="content">
              <div class="ob-center" style="margin-bottom:20px">
                <div class="ob-icon">ü™û</div>
                <div class="ob-title">4 Money Personalities</div>
                <div class="ob-desc">B·∫°n thu·ªôc nh√≥m n√†o? L√†m quiz ƒë·ªÉ kh√°m ph√°!</div>
              </div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                <div style="background:linear-gradient(135deg, #8b5cf6, #a78bfa);border-radius:20px;padding:20px;color:white;text-align:center">
                  <div style="font-size:36px;margin-bottom:8px">‚ú®</div>
                  <div style="font-size:15px;font-weight:700">The Dreamer</div>
                  <div style="font-size:12px;opacity:0.9;margin-top:4px">Ng∆∞·ªùi m∆° m·ªông</div>
                </div>
                <div style="background:linear-gradient(135deg, #f97316, #fb923c);border-radius:20px;padding:20px;color:white;text-align:center">
                  <div style="font-size:36px;margin-bottom:8px">üé¢</div>
                  <div style="font-size:15px;font-weight:700">The Experiencer</div>
                  <div style="font-size:12px;opacity:0.9;margin-top:4px">Ng∆∞·ªùi tr·∫£i nghi·ªám</div>
                </div>
                <div style="background:linear-gradient(135deg, #ec4899, #f472b6);border-radius:20px;padding:20px;color:white;text-align:center">
                  <div style="font-size:36px;margin-bottom:8px">üíù</div>
                  <div style="font-size:15px;font-weight:700">The Giver</div>
                  <div style="font-size:12px;opacity:0.9;margin-top:4px">Ng∆∞·ªùi cho ƒëi</div>
                </div>
                <div style="background:linear-gradient(135deg, #10b981, #34d399);border-radius:20px;padding:20px;color:white;text-align:center">
                  <div style="font-size:36px;margin-bottom:8px">üéØ</div>
                  <div style="font-size:15px;font-weight:700">The Planner</div>
                  <div style="font-size:12px;opacity:0.9;margin-top:4px">Ng∆∞·ªùi k·∫ø ho·∫°ch</div>
                </div>
              </div>
              <div style="margin-top:20px;padding:16px;background:var(--purple-light);border-radius:16px;text-align:center">
                <div style="font-size:14px;color:#6b21a8">üéØ Moni s·∫Ω ƒë·ªìng h√†nh theo phong c√°ch c·ªßa b·∫°n</div>
              </div>
            </div>
            <div class="footer">
              <button class="btn" onclick="startQuiz()">L√†m Quiz ¬∑ 4 c√¢u h·ªèi ‚Üí</button>
              <button class="btn secondary" onclick="skipQuiz()">B·ªè qua</button>
            </div>
          `;
        } else {
          const q = QUIZ[state.quizStep];
          app.innerHTML = `
            <div class="header">
              <button class="btn-back" onclick="quizBack()">‚Üê</button>
              <div class="quiz-progress">
                <div class="quiz-bar"><div class="quiz-bar-fill" style="width:${((state.quizStep + 1) / 4) * 100}%"></div></div>
                <span class="quiz-count">${state.quizStep + 1}/4</span>
              </div>
              <div style="width:44px"></div>
            </div>
            <div class="content">
              <div class="quiz-badge">ü™û Money Personality</div>
              <div class="quiz-question">${q.q}</div>
              ${q.opts.map(opt => `
                <button class="quiz-option" onclick="answerQuiz('${opt.type}')">
                  <span class="quiz-option-icon">${opt.e}</span>
                  <span class="quiz-option-text">${opt.text}</span>
                </button>
              `).join('')}
            </div>
          `;
        }
        return;
      }

      if (state.step === 2) {
        const arch = ARCHETYPES[state.archetype];
        const desc = {
          dreamer: 'B·∫°n c√≥ nhi·ªÅu ∆∞·ªõc m∆° ƒë·∫πp v√† tr√≠ t∆∞·ªüng t∆∞·ª£ng phong ph√∫. Moni s·∫Ω gi√∫p b·∫°n focus v√†o ƒëi·ªÅu quan tr·ªçng nh·∫•t.',
          experiencer: 'B·∫°n tin cu·ªôc s·ªëng l√† ƒë·ªÉ tr·∫£i nghi·ªám. Moni s·∫Ω gi√∫p b·∫°n balance gi·ªØa t·∫≠n h∆∞·ªüng v√† ƒë·∫£m b·∫£o t∆∞∆°ng lai.',
          giver: 'Ni·ªÅm vui c·ªßa b·∫°n l√† mang l·∫°i ni·ªÅm vui cho ng∆∞·ªùi kh√°c. Moni s·∫Ω nh·∫Øc b·∫°n c≈©ng c·∫ßn invest v√†o b·∫£n th√¢n.',
          planner: 'B·∫°n c√≥ k·ª∑ lu·∫≠t t√†i ch√≠nh t·ªët. Moni s·∫Ω gi√∫p b·∫°n optimize h∆°n n·ªØa v√† celebrate nh·ªØng progress nh·ªè.',
        };
        app.innerHTML = `
          <div class="header">
            <button class="btn-back" onclick="backToQuiz()">‚Üê</button>
            <div class="progress-dots">${dots}</div>
            <div style="width:44px"></div>
          </div>
          <div class="content">
            <div style="text-align:center;margin-bottom:8px"><span class="quiz-badge">‚ú® ƒê√¢y l√† b·∫°n!</span></div>
            <div class="result-card" style="background:linear-gradient(135deg, ${arch.color}, ${arch.color}dd)">
              <div class="result-emoji">${arch.emoji}</div>
              <div class="result-type">${arch.name}</div>
              <div class="result-tag">${arch.tag}</div>
            </div>
            <p class="result-desc">${desc[state.archetype]}</p>
          </div>
          <div class="footer"><button class="btn" onclick="nextStep()">Ti·∫øp t·ª•c ‚Üí</button></div>
        `;
        return;
      }

      if (state.step === 3) {
        app.innerHTML = `
          <div class="header">
            <button class="btn-back" onclick="prevStep()">‚Üê</button>
            <div class="progress-dots">${dots}</div>
            <div style="width:44px"></div>
          </div>
          <div class="content">
            <div class="ob-center">
              <div class="ob-icon">üí∞</div>
              <div class="ob-title">Thu nh·∫≠p h√†ng th√°ng</div>
              <div class="ob-desc">ƒê·ªÉ Moni t√≠nh ƒë∆∞·ª£c b·∫°n c√≥ th·ªÉ ti√™u tho·∫£i m√°i bao nhi√™u m·ªói th√°ng.</div>
            </div>
            <div class="income-input-wrap">
              <input id="incomeInput" class="income-input" placeholder="15,000,000" value="${state.income ? parseInt(state.income).toLocaleString('vi-VN') : ''}" onkeyup="handleIncome(this)">
              <span class="income-unit">VND</span>
            </div>
            <div class="presets">
              ${[8,10,15,20,25,30].map(n => `<button class="preset ${parseInt(state.income) === n * 1000000 ? 'active' : ''}" onclick="setIncome(${n * 1000000})">${n}tr</button>`).join('')}
            </div>
            <div class="privacy-note"><span>üîí</span><span>Th√¥ng tin ƒë∆∞·ª£c b·∫£o m·∫≠t v√† ch·ªâ l∆∞u tr√™n thi·∫øt b·ªã</span></div>
          </div>
          <div class="footer"><button class="btn" id="nextBtn" ${state.income ? '' : 'disabled'} onclick="nextStep()">Ti·∫øp t·ª•c ‚Üí</button></div>
        `;
        return;
      }

      // Step 4: Fixed Expenses
      if (state.step === 4) {
        const fixed = totalFixed();
        const addModal = state.showAddFixed ? `
          <div style="position:absolute;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:flex-end;z-index:100">
            <div style="background:var(--bg);border-top-left-radius:28px;border-top-right-radius:28px;padding:24px;width:100%">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">
                <span style="font-size:20px;font-weight:700">‚ûï Th√™m chi ph√≠ c·ªë ƒë·ªãnh</span>
                <button onclick="state.showAddFixed=false;render()" style="width:36px;height:36px;background:var(--card);border:1px solid var(--border);border-radius:18px;font-size:18px;cursor:pointer">√ó</button>
              </div>
              <div style="margin-bottom:16px">
                <label style="font-size:13px;font-weight:600;color:var(--text-muted);display:block;margin-bottom:8px">T√™n kho·∫£n chi</label>
                <input id="newFixedName" class="input" placeholder="VD: Gym, Netflix, H·ªçc ph√≠...">
              </div>
              <div style="margin-bottom:24px">
                <label style="font-size:13px;font-weight:600;color:var(--text-muted);display:block;margin-bottom:8px">S·ªë ti·ªÅn / th√°ng</label>
                <input id="newFixedAmount" class="input" placeholder="500,000" style="font-size:20px;font-weight:600;text-align:center">
              </div>
              <button class="btn" onclick="addCustomFixed()">Th√™m</button>
            </div>
          </div>
        ` : '';
        
        app.innerHTML = `
          <div class="header">
            <button class="btn-back" onclick="prevStep()">‚Üê</button>
            <div class="progress-dots">${dots}</div>
            <div style="width:44px"></div>
          </div>
          <div class="content">
            <div class="ob-center" style="margin-bottom:24px">
              <div class="ob-icon">üè†</div>
              <div class="ob-title">Chi ph√≠ c·ªë ƒë·ªãnh h√†ng th√°ng</div>
              <div class="ob-desc">Nh·ªØng kho·∫£n ph·∫£i tr·∫£ ƒë·ªÅu ƒë·∫∑n. Nh·∫≠p s·ªë ti·ªÅn ho·∫∑c x√≥a n·∫øu kh√¥ng c√≥.</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:12px">
              ${state.fixedExpenses.map((f, idx) => `
                <div style="display:flex;align-items:center;gap:12px;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px 16px">
                  <span style="font-size:24px">${f.e}</span>
                  <span style="flex:1;font-size:15px;color:var(--text)">${f.name}</span>
                  <input 
                    id="fixed_${idx}"
                    style="width:110px;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:15px;text-align:right;font-family:inherit"
                    placeholder="0"
                    value="${f.amount ? parseInt(f.amount).toLocaleString('vi-VN') : ''}"
                    onblur="updateFixedAmount(${idx}, this.value)"
                  >
                  <button onclick="removeFixed(${idx})" style="width:32px;height:32px;background:#fee2e2;border:none;border-radius:8px;color:#ef4444;font-size:16px;cursor:pointer">√ó</button>
                </div>
              `).join('')}
              <button onclick="state.showAddFixed=true;render()" style="display:flex;align-items:center;justify-content:center;gap:8px;padding:16px;background:var(--card);border:2px dashed var(--border);border-radius:14px;color:var(--text-muted);font-size:15px;cursor:pointer;font-family:inherit">
                <span style="font-size:20px">+</span> Th√™m kho·∫£n kh√°c
              </button>
            </div>
            <div style="margin-top:20px;padding:16px;background:var(--bg);border-radius:14px;display:flex;justify-content:space-between;align-items:center">
              <span style="font-size:14px;color:var(--text-soft)">T·ªïng chi ph√≠ c·ªë ƒë·ªãnh</span>
              <span data-fixed-total style="font-size:18px;font-weight:700;color:var(--orange)">${fmt(fixed)}/th√°ng</span>
            </div>
          </div>
          <div class="footer"><button class="btn" onclick="nextStep()">Ti·∫øp t·ª•c ‚Üí</button></div>
          ${addModal}
        `;
        return;
      }

      // Step 5: Goals
      if (state.step === 5) {
        const selectedIds = state.goals.map(g => g.id);
        const available = GOALS.filter(g => !selectedIds.includes(g.id));
        
        const addModal = state.showAddGoal ? `
          <div style="position:absolute;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:flex-end;z-index:100">
            <div style="background:var(--bg);border-top-left-radius:28px;border-top-right-radius:28px;padding:24px;width:100%">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">
                <span style="font-size:20px;font-weight:700">‚ú® T·∫°o m·ª•c ti√™u m·ªõi</span>
                <button onclick="state.showAddGoal=false;render()" style="width:36px;height:36px;background:var(--card);border:1px solid var(--border);border-radius:18px;font-size:18px;cursor:pointer">√ó</button>
              </div>
              <div style="margin-bottom:16px">
                <label style="font-size:13px;font-weight:600;color:var(--text-muted);display:block;margin-bottom:8px">T√™n m·ª•c ti√™u</label>
                <input id="newGoalName" class="input" placeholder="VD: iPhone m·ªõi, Kh√≥a h·ªçc, Xe ƒë·∫°p...">
              </div>
              <div style="margin-bottom:24px">
                <label style="font-size:13px;font-weight:600;color:var(--text-muted);display:block;margin-bottom:8px">S·ªë ti·ªÅn c·∫ßn</label>
                <input id="newGoalAmount" class="input" placeholder="10,000,000" style="font-size:20px;font-weight:600;text-align:center">
              </div>
              <button class="btn" onclick="addCustomGoal()">Th√™m m·ª•c ti√™u</button>
            </div>
          </div>
        ` : '';
        
        app.innerHTML = `
          <div class="header">
            <button class="btn-back" onclick="prevStep()">‚Üê</button>
            <div class="progress-dots">${dots}</div>
            <div style="width:44px"></div>
          </div>
          <div class="content">
            <div class="ob-center">
              <div class="ob-icon">üéØ</div>
              <div class="ob-title">B·∫°n ƒëang h∆∞·ªõng t·ªõi ƒëi·ªÅu g√¨?</div>
              <div class="ob-desc">Ch·ªçn 1-3 m·ª•c ti√™u. Moni s·∫Ω gi√∫p b·∫°n theo d√µi ti·∫øn ƒë·ªô.</div>
            </div>
            ${state.goals.length > 0 ? `<div class="selected-goals">${state.goals.map(g => `
              <div class="selected-goal">
                <span class="selected-goal-icon">${g.e}</span>
                <div class="selected-goal-info">
                  <div class="selected-goal-name">${g.name}</div>
                  <div class="selected-goal-amount">${fmt(g.amount)}</div>
                </div>
                <button class="selected-goal-remove" onclick="removeGoal('${g.id}')">√ó</button>
              </div>
            `).join('')}</div>` : ''}
            <div class="goal-grid" style="margin-top:${state.goals.length > 0 ? '16px' : '24px'}">
              ${available.map(g => `
                <div class="goal-item" onclick="${state.goals.length < 3 ? `addGoal('${g.id}')` : ''}">
                  <span class="goal-item-icon">${g.e}</span>
                  <span class="goal-item-name">${g.name}</span>
                </div>
              `).join('')}
              ${state.goals.length < 3 ? `
                <div class="goal-item" onclick="state.showAddGoal=true;render()" style="border-style:dashed">
                  <span class="goal-item-icon">‚ú®</span>
                  <span class="goal-item-name">T·ª± t·∫°o</span>
                </div>
              ` : ''}
            </div>
          </div>
          <div class="footer"><button class="btn" ${state.goals.length > 0 ? '' : 'disabled'} onclick="nextStep()">Ti·∫øp t·ª•c (${state.goals.length}/3) ‚Üí</button></div>
          ${addModal}
        `;
        return;
      }

      // Step 6: Allocation
      if (state.step === 6) {
        const income = parseInt(state.income) || 0;
        const fixed = totalFixed();
        const allocated = totalAllocation();
        const remaining = spendable();
        app.innerHTML = `
          <div class="header">
            <button class="btn-back" onclick="prevStep()">‚Üê</button>
            <div class="progress-dots">${dots}</div>
            <div style="width:44px"></div>
          </div>
          <div class="content">
            <div class="ob-center" style="margin-bottom:24px">
              <div class="ob-icon">üí∏</div>
              <div class="ob-title">M·ªói th√°ng d√†nh bao nhi√™u?</div>
              <div class="ob-desc">Ch·ªçn s·ªë ti·ªÅn b·∫°n mu·ªën ƒë·ªÉ d√†nh cho m·ªói m·ª•c ti√™u h√†ng th√°ng.</div>
            </div>
            ${state.goals.map((g, idx) => {
              const alloc = state.allocations[g.id] || '';
              const monthly = parseInt(alloc) || 0;
              const months = monthly > 0 ? Math.ceil(g.amount / monthly) : 0;
              return `
                <div class="allocation-card">
                  <div class="allocation-header">
                    <span class="allocation-icon">${g.e}</span>
                    <div>
                      <div class="allocation-name">${g.name}</div>
                      <div class="allocation-target">M·ª•c ti√™u: ${fmt(g.amount)}</div>
                    </div>
                  </div>
                  <div class="allocation-input-row">
                    <input id="alloc_${idx}" class="allocation-input" placeholder="0" value="${alloc ? parseInt(alloc).toLocaleString('vi-VN') : ''}" onblur="updateAllocation('${g.id}', this.value)">
                    <span class="allocation-per">VND / th√°ng</span>
                  </div>
                  <div class="allocation-time" data-time-${idx}>${monthly > 0 ? `ƒê·∫°t m·ª•c ti√™u trong <strong>${months} th√°ng</strong>` : ''}</div>
                </div>
              `;
            }).join('')}
            <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;margin-top:8px">
              <div style="display:flex;justify-content:space-between;margin-bottom:12px">
                <span style="color:var(--text-muted);font-size:14px">Thu nh·∫≠p</span>
                <span style="font-weight:600">${fmt(income)}</span>
              </div>
              <div style="display:flex;justify-content:space-between;margin-bottom:12px">
                <span style="color:var(--text-muted);font-size:14px">Chi ph√≠ c·ªë ƒë·ªãnh</span>
                <span style="font-weight:600;color:var(--text-soft)">-${fmt(fixed)}</span>
              </div>
              <div style="display:flex;justify-content:space-between;margin-bottom:12px">
                <span style="color:var(--text-muted);font-size:14px">ƒê·ªÉ d√†nh cho goals</span>
                <span data-alloc-total style="font-weight:600;color:var(--orange)">-${fmt(allocated)}</span>
              </div>
              <div style="border-top:1px solid var(--border);padding-top:12px;display:flex;justify-content:space-between">
                <span style="font-weight:600">Ti√™u tho·∫£i m√°i</span>
                <span data-remain-total style="font-weight:700;font-size:18px;color:${remaining >= 0 ? 'var(--green)' : '#ef4444'}">${fmt(remaining)}</span>
              </div>
            </div>
          </div>
          <div class="footer"><button class="btn" data-finish-btn ${allocated > 0 && remaining >= 0 ? '' : 'disabled'} onclick="finishOnboarding()">Ho√†n t·∫•t ‚Üí</button></div>
        `;
        return;
      }
    };

    const renderMain = (app) => {
      app.className = 'phone';
      const remaining = spendable() - todaySpent();
      const arch = ARCHETYPES[state.archetype];
      
      const addExpenseModal = state.showAddExpense ? `
        <div style="position:absolute;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:flex-end;z-index:100">
          <div style="background:var(--bg);border-top-left-radius:28px;border-top-right-radius:28px;padding:24px;width:100%">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">
              <span style="font-size:20px;font-weight:700">‚úèÔ∏è Th√™m chi ti√™u</span>
              <button onclick="closeAddExpense()" style="width:36px;height:36px;background:var(--card);border:1px solid var(--border);border-radius:18px;font-size:18px;cursor:pointer">√ó</button>
            </div>
            <div style="margin-bottom:16px">
              <label style="font-size:13px;font-weight:600;color:var(--text-muted);display:block;margin-bottom:8px">T√™n</label>
              <input id="expenseName" class="input" placeholder="VD: Cafe, Grab, ƒÇn tr∆∞a...">
            </div>
            <div style="margin-bottom:24px">
              <label style="font-size:13px;font-weight:600;color:var(--text-muted);display:block;margin-bottom:8px">S·ªë ti·ªÅn</label>
              <input id="expenseAmount" class="input" placeholder="50,000" style="font-size:24px;font-weight:700;text-align:center">
            </div>
            <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:24px">
              <button onclick="quickAddExpense('‚òï','Cafe',50000)" style="padding:10px 16px;background:var(--card);border:1px solid var(--border);border-radius:12px;font-size:14px;cursor:pointer;font-family:inherit">‚òï Cafe 50k</button>
              <button onclick="quickAddExpense('üçú','C∆°m',45000)" style="padding:10px 16px;background:var(--card);border:1px solid var(--border);border-radius:12px;font-size:14px;cursor:pointer;font-family:inherit">üçú C∆°m 45k</button>
              <button onclick="quickAddExpense('üöó','Grab',85000)" style="padding:10px 16px;background:var(--card);border:1px solid var(--border);border-radius:12px;font-size:14px;cursor:pointer;font-family:inherit">üöó Grab 85k</button>
              <button onclick="quickAddExpense('üõí','Si√™u th·ªã',150000)" style="padding:10px 16px;background:var(--card);border:1px solid var(--border);border-radius:12px;font-size:14px;cursor:pointer;font-family:inherit">üõí Si√™u th·ªã 150k</button>
            </div>
            <button class="btn" onclick="confirmAddExpenseFromModal()">Th√™m chi ti√™u</button>
          </div>
        </div>
      ` : '';

      // Chat response section
      let chatSection = '';
      if (state.chatLoading) {
        chatSection = `
          <div class="response show">
            <div class="response-bubble">
              <div class="typing">
                <span></span><span></span><span></span>
              </div>
            </div>
          </div>
        `;
      } else if (state.chatResponse) {
        chatSection = `
          <div class="response show">
            <div class="response-bubble">
              <div class="response-text">${state.chatResponse}</div>
              ${state.chatParsed ? `
                <div class="response-meta">Sau khi mua: <strong>${fmt(remaining - state.chatParsed.amount)}</strong> c√≤n l·∫°i</div>
                <div class="response-actions">
                  <button class="res-btn primary" onclick="confirmChatPurchase()">Mua r·ªìi ‚úì</button>
                  <button class="res-btn secondary" onclick="clearChat()">Th√¥i</button>
                </div>
              ` : `
                <div class="response-actions">
                  <button class="res-btn secondary" onclick="clearChat()" style="flex:none;width:100%">ƒê√≥ng</button>
                </div>
              `}
            </div>
          </div>
        `;
      }
      
      app.innerHTML = `
        <div class="status-bar"><span>9:41</span><span>üì∂ üîã</span></div>
        <div class="content" style="padding: 0 24px;">
          <div class="main-header">
            <div class="greeting">Hey, ${state.userName} üëã</div>
            <div class="avatar">${arch?.emoji || '‚ú®'}</div>
          </div>
          <div class="spendable">
            <div class="spendable-label">Ti√™u tho·∫£i m√°i</div>
            <div class="spendable-amount">${(remaining / 1000000).toFixed(1).replace('.0', '')}<span class="unit">tr</span></div>
            <div class="spendable-sub">c√≤n <span>18 ng√†y</span> n·ªØa</div>
          </div>
          <div class="goals-status">
            ${state.goals.slice(0, 2).map((g, i) => {
              const isOnTrack = i === 0;
              const months = Math.ceil(g.amount / (state.allocations[g.id] || 1000000));
              return `
                <div class="goal-pill ${isOnTrack ? 'on-track' : 'behind'}">
                  <span class="goal-emoji">${g.e}</span>
                  <div class="goal-info">
                    <div class="goal-name">${g.name}</div>
                    <div class="goal-time">
                      <span class="time-expect">M·ª•c ti√™u: ${months} th√°ng</span>
                      <span class="time-reality ${isOnTrack ? 'on-track' : 'behind'}">‚Üí Th·ª±c t·∫ø: ${isOnTrack ? months : months + 1} th√°ng</span>
                    </div>
                    <div class="goal-progress"><div class="goal-progress-fill" style="width: ${isOnTrack ? '72' : '40'}%"></div></div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
          <div class="recent-section">
            <div class="recent-header">
              <span class="recent-title">H√¥m nay</span>
              <span class="recent-total">-${fmt(todaySpent())}</span>
            </div>
            <div class="recent-list">
              ${state.transactions.slice(0, 4).map(tx => `
                <div class="recent-item">
                  <span class="recent-emoji">${tx.emoji}</span>
                  <span class="recent-name">${tx.name}</span>
                  <span class="recent-amount">-${fmt(tx.amount)}</span>
                </div>
              `).join('')}
            </div>
          </div>
          <div class="spacer"></div>
          <div class="ask-section">
            <div class="ask-container">
              <div class="ask-row">
                <div class="ask-icon">üåø</div>
                <input type="text" class="ask-input" placeholder="Mu·ªën mua g√¨?" id="askInput" onkeydown="if(event.key==='Enter')askMoni()">
                <button class="ask-btn" onclick="askMoni()">‚Üí</button>
              </div>
            </div>
            <div class="chips">
              <button class="chip" onclick="askWithText('Cafe 50k')">‚òï Cafe 50k</button>
              <button class="chip" onclick="askWithText('Grab 85k')">üöó Grab 85k</button>
              <button class="chip" onclick="askWithText('ƒÇn t·ªëi 150k')">üçú ƒÇn t·ªëi 150k</button>
            </div>
            ${chatSection}
            <div class="ask-hint">H·ªèi Moni tr∆∞·ªõc khi ti√™u</div>
          </div>
        </div>
        <button class="fab" onclick="openAddExpense()">+</button>
        <div class="tab-bar">
          <button class="tab active"><span class="tab-icon">üè†</span><span class="tab-label">Home</span></button>
          <button class="tab"><span class="tab-icon">üéØ</span><span class="tab-label">Goals</span></button>
          <button class="tab"><span class="tab-icon">üìä</span><span class="tab-label">History</span></button>
        </div>
        ${addExpenseModal}
      `;
    };

    window.startOnboarding = () => { state.screen = 'onboarding'; state.step = 0; render(); };
    window.goSplash = () => { state.screen = 'splash'; render(); };
    window.nextStep = () => { state.step++; render(); };
    window.prevStep = () => { state.step--; render(); };
    window.updateBtn = () => { const btn = $('nextBtn'); if (btn) btn.disabled = !state.userName.trim(); };
    window.startQuiz = () => { state.quizStep = 0; render(); };
    window.skipQuiz = () => { state.archetype = 'dreamer'; state.step = 2; render(); };
    window.quizBack = () => { if (state.quizStep > 0) { state.quizStep--; state.quizAnswers.pop(); } else { state.quizStep = -1; } render(); };
    window.backToQuiz = () => { state.step = 1; state.quizStep = 3; render(); };
    window.answerQuiz = (type) => {
      state.quizAnswers.push(type);
      if (state.quizStep < 3) { state.quizStep++; render(); }
      else {
        const counts = {};
        state.quizAnswers.forEach(t => counts[t] = (counts[t] || 0) + 1);
        let maxType = 'dreamer', maxCount = 0;
        Object.entries(counts).forEach(([t, c]) => { if (c > maxCount) { maxType = t; maxCount = c; } });
        state.archetype = maxType;
        state.step = 2;
        render();
      }
    };
    window.handleIncome = (el) => { state.income = el.value.replace(/\D/g, ''); const btn = $('nextBtn'); if (btn) btn.disabled = !state.income; };
    window.setIncome = (val) => { state.income = val.toString(); render(); };
    
    // Fixed expenses
    window.updateFixedAmount = (idx, val) => { 
      state.fixedExpenses[idx].amount = val.replace(/\D/g, ''); 
      // Update the total display without full re-render
      const totalEl = document.querySelector('[data-fixed-total]');
      if (totalEl) totalEl.textContent = fmt(totalFixed()) + '/th√°ng';
    };
    window.removeFixed = (idx) => { 
      state.fixedExpenses.splice(idx, 1); 
      render(); 
    };
    window.addCustomFixed = () => {
      const name = $('newFixedName')?.value;
      const amount = $('newFixedAmount')?.value.replace(/\D/g, '');
      if (name && amount) {
        const emojis = ['üì¶', 'üé¨', 'üèãÔ∏è', 'üìö', 'üéµ', 'üöå', 'üí≥', 'üîß'];
        state.fixedExpenses.push({
          id: 'custom_' + Date.now(),
          e: emojis[Math.floor(Math.random() * emojis.length)],
          name: name,
          amount: amount
        });
        state.showAddFixed = false;
        render();
      }
    };
    
    // Goals
    window.addGoal = (id) => { 
      if (state.goals.length >= 3) return; 
      const goal = GOALS.find(g => g.id === id); 
      if (goal) { state.goals.push({...goal}); render(); } 
    };
    window.removeGoal = (id) => { 
      state.goals = state.goals.filter(g => g.id !== id); 
      delete state.allocations[id]; 
      render(); 
    };
    window.addCustomGoal = () => {
      const name = $('newGoalName')?.value;
      const amount = $('newGoalAmount')?.value.replace(/\D/g, '');
      if (name && amount && state.goals.length < 3) {
        const emojis = ['üéØ', '‚≠ê', 'üåü', 'üí´', 'üéÅ', 'üèÜ', 'üíé', 'üöÄ'];
        state.goals.push({
          id: 'custom_' + Date.now(),
          e: emojis[Math.floor(Math.random() * emojis.length)],
          name: name,
          amount: parseInt(amount)
        });
        state.showAddGoal = false;
        render();
      }
    };
    
    // Allocation  
    window.updateAllocation = (id, val) => { 
      state.allocations[id] = val.replace(/\D/g, ''); 
      // Update summary without full re-render
      updateAllocationSummary();
    };
    
    window.updateAllocationSummary = () => {
      const income = parseInt(state.income) || 0;
      const fixed = totalFixed();
      const allocated = totalAllocation();
      const remaining = spendable();
      
      const allocEl = document.querySelector('[data-alloc-total]');
      const remainEl = document.querySelector('[data-remain-total]');
      const btn = document.querySelector('[data-finish-btn]');
      
      if (allocEl) allocEl.textContent = '-' + fmt(allocated);
      if (remainEl) {
        remainEl.textContent = fmt(remaining);
        remainEl.style.color = remaining >= 0 ? 'var(--green)' : '#ef4444';
      }
      if (btn) btn.disabled = !(allocated > 0 && remaining >= 0);
      
      // Update time estimates
      state.goals.forEach((g, idx) => {
        const alloc = state.allocations[g.id] || 0;
        const monthly = parseInt(alloc) || 0;
        const months = monthly > 0 ? Math.ceil(g.amount / monthly) : 0;
        const timeEl = document.querySelector(`[data-time-${idx}]`);
        if (timeEl) {
          timeEl.innerHTML = monthly > 0 ? `ƒê·∫°t m·ª•c ti√™u trong <strong>${months} th√°ng</strong>` : '';
        }
      });
    };
    
    window.finishOnboarding = () => { state.screen = 'main'; render(); };
    window.fillInput = (text) => { const input = $('askInput'); if (input) { input.value = text; input.focus(); } };
    
    // Chat functions with Claude API
    window.askWithText = (text) => {
      const input = $('askInput');
      if (input) input.value = text;
      askMoni();
    };
    
    window.askMoni = async () => {
      const input = $('askInput');
      const query = input?.value?.trim();
      if (!query) return;
      
      state.chatLoading = true;
      state.chatResponse = null;
      state.chatParsed = null;
      render();
      
      const remaining = spendable() - todaySpent();
      const goalsInfo = state.goals.map(g => `${g.name}: ${fmt(g.amount)}, ti·∫øt ki·ªám ${fmt(state.allocations[g.id] || 0)}/th√°ng`).join('; ');
      
      const systemPrompt = `B·∫°n l√† Moni, m·ªôt tr·ª£ l√Ω t√†i ch√≠nh th√¢n thi·ªán. B·∫°n gi√∫p user quy·∫øt ƒë·ªãnh c√≥ n√™n mua m·ªôt m√≥n ƒë·ªì hay kh√¥ng d·ª±a tr√™n ng√¢n s√°ch c·ªßa h·ªç.

Th√¥ng tin t√†i ch√≠nh c·ªßa user:
- S·ªë ti·ªÅn c√≥ th·ªÉ ti√™u tho·∫£i m√°i c√≤n l·∫°i: ${fmt(remaining)}
- C√≤n 18 ng√†y trong th√°ng
- M·ª•c ti√™u ƒëang theo ƒëu·ªïi: ${goalsInfo || 'Ch∆∞a c√≥'}

Quy t·∫Øc:
1. Tr·∫£ l·ªùi ng·∫Øn g·ªçn, th√¢n thi·ªán, d√πng emoji
2. N·∫øu user h·ªèi v·ªÅ vi·ªác mua m·ªôt m√≥n ƒë·ªì, h√£y ph√¢n t√≠ch xem c√≥ n√™n mua kh√¥ng
3. N·∫øu m√≥n ƒë·ªì < 5% ng√¢n s√°ch c√≤n l·∫°i ‚Üí khuy·∫øn kh√≠ch mua
4. N·∫øu m√≥n ƒë·ªì 5-20% ng√¢n s√°ch ‚Üí c√¢n nh·∫Øc, n√™u trade-off
5. N·∫øu m√≥n ƒë·ªì > 20% ng√¢n s√°ch ‚Üí c·∫£nh b√°o nh·∫π nh√†ng
6. Lu√¥n t√¥n tr·ªçng quy·∫øt ƒë·ªãnh c·ªßa user, kh√¥ng ph√°n x√©t
7. N·∫øu ph√°t hi·ªán ƒë∆∞·ª£c s·ªë ti·ªÅn trong c√¢u h·ªèi, PH·∫¢I tr·∫£ v·ªÅ ·ªü cu·ªëi response theo format: [PARSED:t√™n_m√≥n:s·ªë_ti·ªÅn]

V√≠ d·ª• response:
"Cafe 50k ‚Äî mua ƒëi! ‚òï Ch·ªâ chi·∫øm 2% ng√¢n s√°ch, kh√¥ng ·∫£nh h∆∞·ªüng g√¨ t·ªõi m·ª•c ti√™u c·ªßa b·∫°n.
[PARSED:Cafe:50000]"`;

      // Always use fallback for now (API may not work in artifact)
      const useFallback = () => {
        // Parse amount with better regex - handle "50k", "50K", "50000", "150k"
        const amountMatch = query.match(/(\d+)\s*k/i) || query.match(/(\d{4,})/);
        if (amountMatch) {
          let amount = parseInt(amountMatch[1]);
          // If matched with 'k', multiply by 1000
          if (query.toLowerCase().includes('k') && amount < 1000) {
            amount *= 1000;
          }
          // Extract item name (everything except the amount part)
          const item = query.replace(/\d+\s*k?/gi, '').trim() || 'M√≥n n√†y';
          const percent = remaining > 0 ? (amount / remaining * 100) : 100;
          
          state.chatParsed = { item, amount };
          
          if (percent < 5) {
            state.chatResponse = `<strong>${item} ${fmt(amount)}</strong> ‚Äî mua ƒëi! üéâ<br><br>Ch·ªâ ${percent.toFixed(1)}% ng√¢n s√°ch, tho·∫£i m√°i!`;
          } else if (percent < 20) {
            state.chatResponse = `<strong>${item} ${fmt(amount)}</strong> ‚Äî ƒë∆∞·ª£c th√¥i! üëç<br><br>Chi·∫øm ${percent.toFixed(1)}% ng√¢n s√°ch. C√¢n nh·∫Øc ch√∫t nh√©.`;
          } else {
            state.chatResponse = `<strong>${item} ${fmt(amount)}</strong> ‚Äî h∆°i nhi·ªÅu ƒë√≥! ü§î<br><br>Chi·∫øm ${percent.toFixed(1)}% ng√¢n s√°ch c√≤n l·∫°i. B·∫°n ch·∫Øc ch·ª©?`;
          }
        } else {
          state.chatResponse = 'Moni ch∆∞a hi·ªÉu l·∫Øm. B·∫°n th·ª≠ nh·∫≠p ki·ªÉu "Cafe 50k" ho·∫∑c "Grab 85k" nh√©! üòä';
        }
      };

      try {
        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 500,
            system: systemPrompt,
            messages: [{ role: 'user', content: query }]
          })
        });
        
        if (!response.ok) {
          throw new Error('API error');
        }
        
        const data = await response.json();
        let text = data.content?.[0]?.text;
        
        if (!text) {
          throw new Error('No response');
        }
        
        // Parse the response for item and amount
        const parseMatch = text.match(/\[PARSED:(.+?):(\d+)\]/);
        if (parseMatch) {
          state.chatParsed = {
            item: parseMatch[1],
            amount: parseInt(parseMatch[2])
          };
          text = text.replace(/\[PARSED:.+?\]/, '').trim();
        }
        
        state.chatResponse = text.replace(/\n/g, '<br>');
      } catch (err) {
        console.error('API Error:', err);
        useFallback();
      }
      
      state.chatLoading = false;
      render();
    };
    
    window.clearChat = () => {
      state.chatResponse = null;
      state.chatParsed = null;
      const input = $('askInput');
      if (input) input.value = '';
      render();
    };
    
    window.confirmChatPurchase = () => {
      if (state.chatParsed) {
        const emojis = ['‚òï', 'üçú', 'üöó', 'üõí', 'üé¨', 'üõçÔ∏è', 'üíä', 'üì¶'];
        const item = state.chatParsed.item;
        let emoji = emojis[0];
        if (item.toLowerCase().includes('cafe') || item.toLowerCase().includes('c√† ph√™')) emoji = '‚òï';
        else if (item.toLowerCase().includes('c∆°m') || item.toLowerCase().includes('ƒÉn')) emoji = 'üçú';
        else if (item.toLowerCase().includes('grab') || item.toLowerCase().includes('xe')) emoji = 'üöó';
        else if (item.toLowerCase().includes('si√™u th·ªã') || item.toLowerCase().includes('ch·ª£')) emoji = 'üõí';
        else emoji = emojis[Math.floor(Math.random() * emojis.length)];
        
        state.transactions.unshift({
          emoji,
          name: state.chatParsed.item,
          amount: state.chatParsed.amount
        });
      }
      clearChat();
    };
    
    window.openAddExpense = () => { state.showAddExpense = true; render(); };
    window.closeAddExpense = () => { state.showAddExpense = false; render(); };
    window.confirmAddExpenseFromModal = () => {
      const name = $('expenseName')?.value;
      const amount = $('expenseAmount')?.value?.replace(/\D/g, '');
      if (name && amount) {
        const emojis = ['üõçÔ∏è', 'üçΩÔ∏è', 'üé¨', 'üéÅ', 'üíä', 'üì¶', 'üéÆ', '‚ú®'];
        state.transactions.unshift({
          emoji: emojis[Math.floor(Math.random() * emojis.length)],
          name,
          amount: parseInt(amount)
        });
        state.showAddExpense = false;
        render();
      }
    };
    window.quickAddExpense = (emoji, name, amount) => {
      state.transactions.unshift({ emoji, name, amount });
      state.showAddExpense = false;
      render();
    };

    render();
  </script>
</body>
</html>
